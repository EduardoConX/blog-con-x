---
import type { GetStaticPaths } from "astro";
import { getCollection } from "astro:content";

import Layout from "@/layouts/Layout.astro";
import PageTitle from "@/components/PageTitle.astro";
import GridPosts from "@/components/GridPosts.astro";
import Pagination from "@/components/Pagination.astro";

export const getStaticPaths = (async ({ paginate }) => {
  const [categories, posts] = await Promise.all([
    getCollection("categories"),
    getCollection("posts"),
  ]);

  return categories.flatMap((category) => {
    const categoryPosts = posts
      .filter((post) => post.data.category.id === category.id)
      .sort((a, b) => Number(b.data.date) - Number(a.data.date));

    return paginate(categoryPosts, {
      params: { category: category.id },
      pageSize: 10,
      props: { category },
    });
  });
}) satisfies GetStaticPaths;

const { category, page } = Astro.props;
---

<Layout>
  <main class="lg:col-span-3">
    <section class="mb-12">
      <PageTitle
        pageTitle={category.data.name}
        isIndex={false}
        pageSize={page.data.length}
      />
      <GridPosts posts={page.data} />
      <Pagination
        currentPage={page.currentPage}
        lastPage={page.lastPage}
        prevUrl={page.url.prev}
        nextUrl={page.url.next}
      />
    </section>
  </main>
</Layout>
