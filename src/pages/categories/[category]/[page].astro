---
import type { GetStaticPaths } from "astro";
import { getCollection } from "astro:content";

import Layout from "@/layouts/Layout.astro";
import PostCard from "@/components/PostCard.astro";
import Pagination from "@/components/Pagination.astro";

export const getStaticPaths = (async ({ paginate }) => {
  const [categories, posts] = await Promise.all([
    getCollection("categories"),
    getCollection("posts"),
  ]);

  return categories.flatMap((category) => {
    const categoryPosts = posts
      .filter((post) => post.data.category.id === category.id)
      .sort((a, b) => Number(b.data.date) - Number(a.data.date));

    return paginate(categoryPosts, {
      params: { category: category.id },
      pageSize: 10,
      props: { category },
    });
  });
}) satisfies GetStaticPaths;

const { category, page } = Astro.props;
---

<Layout>
  <main class="lg:col-span-3">
    <section class="mb-12">
      <div class="mb-6">
        <h2 class="text-3xl md:text-4xl font-bold mb-2">
          {category.data.name}
        </h2>
        {
          category.data.description && (
            <p class="text-muted-foreground mb-2">
              {category.data.description}
            </p>
          )
        }
        <p class="text-sm text-muted-foreground">
          Showing {page.data.length} of {
            page.data.length + (page.lastPage - page.currentPage) * 10
          } post{page.data.length !== 1 ? "s" : ""}
        </p>
      </div>
      <div class="grid gap-6 md:grid-cols-2">
        {page.data.map((post) => <PostCard post={post} category={category} />)}
      </div>
      <Pagination
        currentPage={page.currentPage}
        lastPage={page.lastPage}
        prevUrl={page.url.prev}
        nextUrl={page.url.next}
      />
    </section>
  </main>
</Layout>
